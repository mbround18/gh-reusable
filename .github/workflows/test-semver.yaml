name: "Test | Semver Action"

on:
  pull_request:
    branches: [main]
  push:
    tags: ["*"]
    branches: [main]

jobs:
  ensure_repository:
    name: Ensure Repository
    runs-on: ubuntu-latest
    steps:
      - name: Verify Repo is mbround18/gh-reusable
        uses: mbround18/gh-reusable/actions/ensure-repository@v0.0.5

  call_semver_action:
    name: Call Semver Action
    runs-on: ubuntu-latest
    needs: ensure_repository
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- Direct increments with base ---
      - name: Semver - Patch Increment
        id: semver_patch
        uses: ./actions/semver
        with:
          base: "1.2.3"
          increment: "patch"

      - name: Verify - Patch
        run: |
          [[ "${{ steps.semver_patch.outputs.new_version }}" == "1.2.4" ]] || exit 1

      - name: Semver - Minor Increment
        id: semver_minor
        uses: ./actions/semver
        with:
          base: "2.3.4"
          increment: "minor"

      - name: Verify - Minor
        run: |
          [[ "${{ steps.semver_minor.outputs.new_version }}" == "2.4.0" ]] || exit 1

      - name: Semver - Major Increment
        id: semver_major
        uses: ./actions/semver
        with:
          base: "3.4.5"
          increment: "major"

      - name: Verify - Major
        run: |
          [[ "${{ steps.semver_major.outputs.new_version }}" == "4.0.0" ]] || exit 1

      # --- Prefix support ---
      - name: Semver - Prefix + Base
        id: semver_prefix
        uses: ./actions/semver
        with:
          base: "chart-1.0.0"
          prefix: "chart-"
          increment: "minor"

      - name: Verify - Prefix
        run: |
          [[ "${{ steps.semver_prefix.outputs.new_version }}" == "chart-1.1.0" ]] || exit 1

      # --- Auto from tags (must mock with base fallback in test) ---
      - name: Semver - Auto Tag Bump (fallback to patch)
        id: semver_auto_tag
        uses: ./actions/semver
        with:
          base: "0.9.9"

      - name: Verify - Auto Tag
        run: |
          [[ "${{ steps.semver_auto_tag.outputs.new_version }}" == "0.9.10" ]] || exit 1

      # --- PR label based inference (simulate labels) ---
      - name: Semver - Label Inference (minor)
        id: semver_pr_label
        uses: ./actions/semver
        with:
          base: "5.0.0"
          prefix: "lib-"
          increment: "" # required for label-based detection

      - name: Debug PR label-based version
        run: |
          echo "Version: ${{ steps.semver_pr_label.outputs.new_version }}"

      # --- No label on PR: fallback to preview version ---
      - name: Semver - PR Preview Fallback
        id: semver_preview
        uses: ./actions/semver
        with:
          base: "1.2.3"
          increment: ""

      - name: Verify - Preview fallback
        run: |
          [[ "${{ steps.semver_preview.outputs.new_version }}" == 1.2.3-* ]] || exit 1

      # --- Default branch commit with inferred label ---
      - name: Semver - Commit Label Inference (simulate commit context)
        id: semver_commit_label
        uses: ./actions/semver
        with:
          base: "2.0.0"
          increment: ""

      - name: Debug - Commit Inferred Version
        run: |
          echo "Version: ${{ steps.semver_commit_label.outputs.new_version }}"

      # --- Custom label values ---
      - name: Semver - Custom Labels
        id: semver_custom_labels
        uses: ./actions/semver
        with:
          base: "3.0.0"
          major-label: "üöÄmajor"
          minor-label: "‚ú®minor"
          patch-label: "üêûpatch"
          increment: ""

      - name: Debug - Custom Label Version
        run: |
          echo "Version: ${{ steps.semver_custom_labels.outputs.new_version }}"
